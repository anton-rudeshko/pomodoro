!function(a,b){function c(a){this.name=a||"",this.periods=[]}function d(a){this.type=a,this.time=(new Date).getTime()}function e(){return k.fromJson(m.tasks||"[]")}function f(a){m.tasks=k.toJson(a)}function g(){var a=b.createElement("audio");a.src="assets/alert.mp3",a.load(),a.play()}function h(a){b.title="Time is up!"+(a?" - "+a:"")+" - Pomodoro tracker",g();var c=new Notification("Pomodoro tracker",{tag:"pomodoro-tracker",body:(a?a+" - ":"")+"Time is up!"});c.onshow=function(){setTimeout(function(){c.close()},5*q)}}function i(a){return a=new Date(a),new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime()}function j(){return i(new Date)}var k=a.angular,l=a.ga,m=a.localStorage||{},n="pomodoro",o=k.module(n,[]),p=m.isDev,q=1e3,r=60*q,s=p?q:r,t={pomodoro:25*s,shortBreak:5*s,longBreak:15*s},u="mm:ss",v="Some task",w=a.Notification;o.filter("todayPeriods",function(){return function(a){var b=j();return a.reduce(function(a,b){return a.concat(b.periods||[])},[]).filter(function(a){return b===i(a.time)})}}),o.filter("pomodoros",function(){return function(a){return a.filter(function(a){return a.type===n}).length||""}}),o.controller("MainCtrl",["$scope","$interval","dateFilter",function(g,i,j){var k=this,m=g.tasks=e();a.onbeforeunload=function(){return k.isTicking()?"Still ticking!":void 0},g.timerType=n,g.formattedTime=j(t.pomodoro,u),g.currentTask=new c,g.removeTask=function(a){m.splice(m.indexOf(a),1),f(m)},k.updateTimeDisplay=function(a,c){g.formattedTime=j(a,u),b.title=g.formattedTime+(c?" - "+c:"")+" - Pomodoro tracker"},k.isTicking=function(){return!!k.countdownInterval},k.startCountdown=function(a,b){if(a&&b&&!k.isTicking()){var e=a,j=g.currentTask;m.some(function(a){return j.name.match(new RegExp(a.name.trim(),"gi"))?(g.currentTask=j=a,!0):!1}),g.timerType=b,k.updateTimeDisplay(e,j.name),k.countdownInterval=i(function(){e-=q,k.updateTimeDisplay(e,j.name)},q,e/q),k.countdownInterval.then(function(){k.countdownInterval=null,j.name||(j.name=v),~m.indexOf(j)||m.unshift(j),j.periods.push(new d(b)),g.currentTask=new c(j.name),f(m),h(j.name),l("send","event",b,"end")})}},k.cancelCountdown=function(){i.cancel(k.countdownInterval),k.countdownInterval=null},k.restartCountdown=function(a,b){k.cancelCountdown(),k.startCountdown(a,b)},g.select=function(a){g.currentTask=a},g.start=function(a){b.activeElement.blur();var c=t[a];c&&(k.restartCountdown(c,a),l("send","event",a,"start"))},g.submit=function(){b.activeElement.blur(),k.isTicking()||k.restartCountdown(t[n],n)},g.showNotifyButton=w&&"granted"!==w.permission,g.turnNotifications=function(){w.requestPermission(),g.showNotifyButton=!1}}])}(window,document);