!function(a,b){function c(a){return("00"+a).slice(-2)}function d(a){this.name=a||"",this.periods=[]}function e(a){return a.name.trim().toLowerCase()}function f(a,b){return e(a)===e(b)}function g(a){this.type=a,this.time=(new Date).getTime()}function h(){return n.fromJson(p.tasks||"[]")}function i(a){p.tasks=n.toJson(a)}function j(){var a=b.createElement("audio");a.src="assets/alert.mp3",a.load(),a.play()}function k(a){b.title="Time is up!"+(a?" - "+a:"")+" - Pomodoro Tracker",j();var c=new Notification("Pomodoro Tracker",{tag:"pomodoro-tracker",body:(a?a+" - ":"")+"Time is up!"});c.onshow=function(){setTimeout(function(){c.close()},5*t)}}function l(a){return a=new Date(a),new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime()}function m(){return l(new Date)}var n=a.angular,o=a.ga,p=a.localStorage||{},q="pomodoro",r=n.module(q,[]),s=p.isDev,t=1e3,u=60*t,v=s?t/5:u,w={pomodoro:25*v,shortBreak:5*v,longBreak:15*v},x="mm:ss",y="Some task",z=a.Notification;r.filter("periods",function(){return function(a){return a.reduce(function(a,b){return a.concat(b.periods||[])},[])}}),r.filter("today",["periodsFilter",function(a){return function(b){var c=m();return a(b).filter(function(a){return c===l(a.time)})}}]),r.filter("pomodoros",function(){return function(a){return a.filter(function(a){return a.type===q}).length||""}}),r.filter("spent",function(){return function(a){var b=a.reduce(function(a,b){return a+w[b.type]},0)/v,d=b/60>>0;return b%=60,d+":"+c(b)}}),r.controller("MainCtrl",["$scope","$interval","dateFilter",function(c,e,j){function l(a){for(var b=0,c=n.length;c>b;b++)if(f(n[b],a))return n[b]}var m=this,n=c.tasks=h();a.onbeforeunload=function(){return m.isTicking()?"Still ticking!":void 0},c.timerType=q,c.formattedTime=j(w.pomodoro,x),c.currentTask=new d,c.removeTask=function(a){n.splice(n.indexOf(a),1),i(n)},m.updateTimeDisplay=function(a,d){c.formattedTime=j(a,x),b.title=c.formattedTime+(d?" - "+d:"")+" - Pomodoro Tracker"},m.isTicking=function(){return!!m.countdownInterval},m.startCountdown=function(a,b){if(a&&b&&!m.isTicking()){var f=a,h=c.currentTask=l(c.currentTask)||c.currentTask;c.timerType=b,m.updateTimeDisplay(f,h.name),m.countdownInterval=e(function(){f-=t,m.updateTimeDisplay(f,h.name)},t,f/t),m.countdownInterval.then(function(){m.countdownInterval=null,h.name||(h.name=y);var a=l(h);a?h=a:n.unshift(h),h.periods.push(new g(b)),c.currentTask=new d(h.name),i(n),k(h.name),o("send","event",b,"end")})}},m.cancelCountdown=function(){e.cancel(m.countdownInterval),m.countdownInterval=null},m.restartCountdown=function(a,b){m.cancelCountdown(),m.startCountdown(a,b)},c.select=function(a){c.currentTask=a},c.start=function(a){b.activeElement.blur();var c=w[a];c&&(m.restartCountdown(c,a),o("send","event",a,"start"))},c.submit=function(){b.activeElement.blur(),m.isTicking()||m.restartCountdown(w[q],q)},c.showNotifyButton=z&&"granted"!==z.permission,c.turnNotifications=function(){z.requestPermission(),c.showNotifyButton=!1}}])}(window,document);