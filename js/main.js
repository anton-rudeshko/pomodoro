!function(a,b){function c(){return+new Date}function d(a){return("00"+a).slice(-2)}function e(a){this.name=a||"",this.periods=[]}function f(a){return a.name.trim().toLowerCase()}function g(a,b){return f(a)===f(b)}function h(a){this.type=a,this.time=c()}function i(){return o.fromJson(q.tasks||"[]")}function j(a){q.tasks=o.toJson(a)}function k(){var a=b.createElement("audio");a.src="assets/alert.mp3",a.load(),a.play()}function l(a){b.title="Time is up!"+(a?" - "+a:"")+" - Pomodoro Tracker",k();var c=new Notification("Pomodoro Tracker",{tag:"pomodoro-tracker",body:(a?a+" - ":"")+"Time is up!"});c.onshow=function(){setTimeout(function(){c.close()},5*u)}}function m(a){return a=new Date(a),new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime()}function n(){return m(new Date)}var o=a.angular,p=a.ga,q=a.localStorage||{},r="pomodoro",s=o.module(r,[]),t=q.isDev,u=1e3,v=60*u,w=t?u/5:v,x={pomodoro:25*w,shortBreak:5*w,longBreak:15*w},y="mm:ss",z="Some task",A=a.Notification;s.filter("periods",function(){return function(a){return a.reduce(function(a,b){return a.concat(b.periods||[])},[])}}),s.filter("today",["periodsFilter",function(a){return function(b){var c=n();return a(b).filter(function(a){return c===m(a.time)})}}]),s.filter("pomodoros",function(){return function(a){return a.filter(function(a){return a.type===r}).length||""}}),s.filter("spent",function(){return function(a){var b=a.reduce(function(a,b){return a+x[b.type]},0)/w,c=b/60>>0;return b%=60,c+":"+d(b)}}),s.controller("MainCtrl",["$scope","$interval","dateFilter",function(d,f,k){function m(a){for(var b=0,c=o.length;c>b;b++)if(g(o[b],a))return o[b]}var n=this,o=d.tasks=i();a.onbeforeunload=function(){return n.isTicking()?"Still ticking!":void 0},d.timerType=r,d.formattedTime=k(x.pomodoro,y),d.currentTask=new e,d.removeTask=function(a){o.splice(o.indexOf(a),1),j(o)},n.updateCountdownDisplay=function(a,c){d.formattedTime=k(a,y),b.title=d.formattedTime+(c?" - "+c:"")+" - Pomodoro Tracker"},n.isTicking=function(){return!!n.countdownInterval},n.startCountdown=function(a){function b(){k.name||(k.name=z);var b=m(k);b?k=b:o.unshift(k),k.periods.push(new h(a)),d.currentTask=new e(k.name),j(o),l(k.name),p("send","event",a,"end")}var g=x[a];if(g&&!n.isTicking()){var i=c(),k=d.currentTask=m(d.currentTask)||d.currentTask,q=u/4;d.timerType=a,n.updateCountdownDisplay(g,k.name),n.countdownInterval=f(function(){var a=c()-i,d=Math.max(g-a,0);d=Math.ceil(d/u)*u,n.updateCountdownDisplay(d,k.name),d>0||(n.stopCountdown(),b())},q),p("send","event",a,"start")}},n.stopCountdown=function(){f.cancel(n.countdownInterval),n.countdownInterval=null},n.restartCountdown=function(a){n.stopCountdown(),n.startCountdown(a)},d.select=function(a){d.currentTask=a},d.start=function(a){b.activeElement.blur(),n.restartCountdown(a)},d.submit=function(){n.isTicking()||d.start(r)},d.showNotifyButton=A&&"granted"!==A.permission,d.turnNotifications=function(){A.requestPermission(),d.showNotifyButton=!1}}])}(window,document);